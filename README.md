# 기능 요구 사항

## 1단계 - 복제 지연 (replication lag)

1. 쿠폰 생성, 조회 기능 구현

- [x] 데이터소스 초기설정
- [x] 쓰기, 읽기 데이터 소스 분리 설정
    - [x] AbstractRoutingDataSource 상속해 트랜잭션 읽기 전용 여부 확인 후, 필요한 데이터 소스 사용하도록 설정
    - [x] LazyConnectionDataSourceProxy 사용해 커넥션 가져오는 시점 늦춰, 커넥션 가져오는 시점과 트랜잭션 설정 시점 같게 설정
- [x] 쿠폰 엔티티 추가 (도메인 엔티티이자 JPA 엔티티)
    - [x] 이름: 반드시 존재, 최대 30자 이하
    - [x] 할인 금액: 1,000원 이상 10,000원 이하, 500원 단위
        - [x] 할인율: 할인 금액 / 최소 주문 금액(소수점 버림), 3% 이상 20% 이하
    - [x] 최소 주문 금액: 5,000원 이상 100,000원 이하
    - [x] 카테고리: 패션/가전/가구/식품 중 하나만 가능
    - [x] 발급 기간: 시작일 <= 종료일, 시작일 00:00:00.000000 ~ 종료일 23:59:59.999999까지 발급 가능
- [x] 쿠폰 생성 기능 구현
- [x] 쿠폰 조회 기능 구현
    - [x] reader DB의 데이터 조회

2. 복제 지연으로 인한 이슈 확인

- [x] 테스트 코드 추가해 쿠폰 생성 후 즉시 조회 시 복제 지연으로 인해 데이터 조회 실패하는 이슈 확인
    - 복제 지연 위해 의도적으로 1초의 지연 시간 설정되어 있음

3. 복제 지연으로 인한 이슈 해결

- [x] 쿠폰 생성 시, 의도한 대로 쿠폰 생성됐는지 검증하도록 수정

## 2단계 - 캐시 (cache)

1. 회원에게 쿠폰을 발급하는 기능 구현

- [x] 회원 엔티티 추가
    - [x] 회원 PK
    - [x] 이름: 반드시 존재, 최대 15자 이하
- [ ] 회원 쿠폰 엔티티 추가
    - [ ] 회원 쿠폰 PK, 쿠폰 PK, 회원 PK, 사용 여부, 발급 일시
    - [ ] 만료 일시: 발급일 포함 7일동안 사용 가능, 만료일의 23:59:59.999999까지 사용 가능
- [ ] 한 명의 회원에게 동일한 쿠폰을 사용한 쿠폰을 포함하여 최대 5장까지 발급 가능하게 구현

2. 회원의 쿠폰 목록 조회 기능 구현

- [ ] 회원에게 발급된 쿠폰의 정보를 모두 보여주게 구현
    - [ ] `회원`, `쿠폰`, `회원에게 발급된 쿠폰`의 저장소가 분리되어 있어서 테이블 조인 불가하다고 가정

3. 쿠폰 캐싱

- [ ] 회원의 쿠폰 목록 조회 시 쿠폰 정보는 캐시를 통해 조회하도록 수정
- [ ] 쿠폰 수정 기능은 존재하지 않는다고 가정

# 학습 내용

## 복제 지연으로 인한 문제점

- 쓰기 작업 후 바로 읽기 작업 진행 시 다른 데이터 읽혀 정합성 문제 발생 가능

## 복제 지연 해결 방법

- read db에서 PK로 조회 성공하면 그 값 반환, 조회 실패하면 write db에서 값 조회해 반환
    - 주의사항: insert 작업에 대한 복제지연만 해결 가능
- 쓰기 작업 끝난 데이터를 캐시에 저장해 곧바로 제공
    - Write-through: db에 쓰면서 캐시에도 저장 → 쓰자마자 읽기 가능, 일관성 유지 어려움
    - Cache-aside: 캐시 조회 후 없으면 db에서 조회 → 공간 효율적, 첫 조회 지연 가능
    - Write-back: 캐시에 먼저 쓰고, 시간 지나면 db에 동기화 → 쓰기 성능 최적화, 쓰기 부하 분산, 데이터 일관성 문제
    - TTL 설정으로 데이터 만료 관리: 일정 시간 지나면 db에서 새로운 데이터로 캐시 갱신 → 최신데이터만 가짐, ttl짧으면 db 성능에 영향 줌
    - pub/sub 구조로 데이터 변경 알림: db 변경 시 알림 받아 해당 데이터를 업데이트하거나 삭제 → 실시간 갱신 가능, pub/sub 구현 필요
- 중요한 데이터를 쓰기 후 즉시 읽어야 할 땐, write db에서 읽을 수 있게 별도 설정하기

# 자바 쿠폰

## 쿠폰 생성, 조회 기능 구현

### 쿠폰

* **쿠폰 이름**
  * [x] 쿠폰 이름은 반드시 존재해야 한다.
  * [x] 길이는 최대 30자 이하여야 한다.
* **할인 금액**
  * [x] 할인 금액은 최소 1,000원 이상, 최대 10,000원 이하다.
  * [x] 할인 금액은 500원 단위로 설정한다.
* **할인율 제약**
  * [x] 할인율은 할인금액/최소 주문 금액 으로 계산하며 소수점은 버림한다.
  * [x] 할인율은 3%이상 20%이하이다.
* **최소 주문 금액**
  * [x] 최소 주문 금액은 5,000원 이상 100,000원 이하이다.
* **카테고리**
  * [x] 카테고리는 `패션`, `가전`, `가구`, `식품` 총 네 종류이다.
* **발급 기간**
  * [x] 시작일은 종료일보다 이전이어야 한다.
  * [x] 시작일 00:00:000000 부터 발급가능
  * [x] 종료일 23:59:59:999999 까지 발급가능

### 회원 쿠폰

* [x] 회원 쿠폰 PK, 쿠폰 PK, 회원 PK, 사용 여부, 발급 일시, 만료 일시 정보를 가진다.
* [ ] 회원에게 발급된 쿠폰은 발급일 포함 7일 동안 사용 가능
  * 만료일의 23:59:59:999999 까지 사용 가능

## 복제 지연으로 인한 이슈 확인

* [x] 테스트 코드로 확인한다.

```java
@SpringBootTest
public class CouponServiceTest {

    @Autowired
    private CouponService couponService;

    @Test
    void 복제지연테스트() {
        Coupon coupon = new Coupon(1000, 10000);
        couponService.create(coupon);
        Coupon savedCoupon = couponService.getCoupon(coupon.getId());
        assertThat(savedCoupon).isNotNull();
    }
}
```

---

## 복제 지연 문제 해결 방법

* 일단 원인 파악이 우선이다.
* 바이너리 로그를 저장하는 방식은 row, statement, mixed이 있는데 원인을 분석하고 어떤 저장방식을 가져가는게 좋을지 고민해본다.
* 현재는 reader db에 데이터가 없을 시, writer db를 찔러보는 방식을 택했다.
* 이 방식의 문제점은 복제 지연 문제가 많이 발생하는 경우 db 분리 이점을 누릴 수 없다는 게 클 것 같다.

### 쿠폰 캐싱

* [x] 한 명의 회원은 동일한 쿠폰을 최대 5장 까지 발급할 수 있다. (사용한 쿠폰 포함)
* [x] 회원의 쿠폰 목록 조회 시 쿠폰, 회원에게 발급된 쿠폰의 정보를 모두 보여야 한다.
* [x] 성능을 위해 쿠폰을 캐싱한다. 회원의 쿠폰 목록 조회 시 쿠폰 정보는 캐시를 통해 조회하도록 수정한다.


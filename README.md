# 기능 요구 사항

## 1단계 - 복제 지연 (replication lag)

1. 쿠폰 생성, 조회 기능 구현

- [x] 데이터소스 초기설정
- [x] 쓰기, 읽기 데이터 소스 분리 설정
    - [x] AbstractRoutingDataSource 상속해 트랜잭션 읽기 전용 여부 확인 후, 필요한 데이터 소스 사용하도록 설정
    - [x] LazyConnectionDataSourceProxy 사용해 커넥션 가져오는 시점 늦춰, 커넥션 가져오는 시점과 트랜잭션 설정 시점 같게 설정
- [ ] 쿠폰 도메인 추가
  - [ ] 이름: 반드시 존재, 최대 30자 이하
  - [ ] 할인 금액: 1,000원 이상 10,000원 이하, 500원 단위
    - [ ] 할인율: 할인 금액 / 최소 주문 금액(소수점 버림), 3% 이상 20% 이하
  - [ ] 최소 주문 금액: 5,000원 이상 100,000원 이하
  - [ ] 카테고리: 패션/가전/가구/식품 중 하나만 가능
  - [ ] 발급 기간: 시작일 <= 종료일, 시작일 00:00:00.000000 ~ 종료일 23:59:59.999999까지 발급 가능
- [ ] 쿠폰 생성 기능 구현
- [ ] 쿠폰 조회 기능 구현
  - [ ] reader DB의 데이터 조회

2. 복제 지연으로 인한 이슈 확인

- [ ] 테스트 코드 추가해 쿠폰 생성 후 즉시 조회 시 복제 지연으로 인해 데이터 조회 실패하는 이슈 확인
  - 복제 지연 위해 의도적으로 1초의 지연 시간 설정되어 있음

3. 복제 지연으로 인한 이슈 해결

- [ ] 쿠폰 생성 시, 의도한 대로 쿠폰 생성됐는지 검증하도록 수정

# 학습 내용

## 복제 지연으로 인한 문제점

- 쓰기 작업 후 바로 읽기 작업 진행 시 다른 데이터 읽혀 정합성 문제 발생 가능

## 복제 지연 해결 방법

- 중요한 데이터를 쓰기 후 즉시 읽어야 할 땐, write db에서 읽을 수 있게 별도 설정하기
- 레플리카 지연 정도 모니터링해, 임계치 초과 시 read 요청을 write db로 리다이렉션 혹은 대기
- 여러 개 레플리카 중 가장 빠른 레플리카로 요청 분배
- 쓰기 작업 끝난 데이터를 캐시에 저장해 곧바로 제공
    - Write-through: db에 쓰면서 캐시에도 저장 → 쓰자마자 읽기 가능, 일관성 유지 어려움
    - Cache-aside: 캐시 조회 후 없으면 db에서 조회 → 공간 효율적, 첫 조회 지연 가능
    - Write-back: 캐시에 먼저 쓰고, 시간 지나면 db에 동기화 → 쓰기 성능 최적화, 쓰기 부하 분산, 데이터 일관성 문제
    - TTL 설정으로 데이터 만료 관리: 일정 시간 지나면 db에서 새로운 데이터로 캐시 갱신 → 최신데이터만 가짐, ttl짧으면 db 성능에 영향 줌
    - pub/sub 구조로 데이터 변경 알림: db 변경 시 알림 받아 해당 데이터를 업데이트하거나 삭제 → 실시간 갱신 가능, pub/sub 구현 필요
